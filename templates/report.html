<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Lease Property Report</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header with logo */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            border-bottom: 2px solid #2d3748;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #5ba3a5 0%, #4a8f91 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 28px;
            height: 28px;
            fill: #1a202c;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #e2e8f0;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: #5ba3a5;
        }

        .header-title {
            text-align: right;
        }

        .file-upload {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .upload-btn {
            background: linear-gradient(135deg, #5ba3a5 0%, #4a8f91 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(91, 163, 165, 0.3);
        }

        .upload-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        #csv-input {
            display: none;
        }

        .header-title h1 {
            font-size: 24px;
            color: #e2e8f0;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header-title .date {
            color: #a0aec0;
            font-size: 14px;
        }

        /* Summary cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #5ba3a5;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(91, 163, 165, 0.25);
        }

        .card-value {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #8ecfd0;
        }

        .card-label {
            font-size: 14px;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        /* Charts section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1000px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            min-height: 350px;
        }

        .chart-title {
            font-size: 16px;
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #5ba3a5;
        }

        /* Data table */
        .table-container {
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .table-title {
            font-size: 18px;
            color: #e2e8f0;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #5ba3a5;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background-color: #1a202c;
            color: #8ecfd0;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        th:first-child {
            border-radius: 8px 0 0 0;
        }

        th:last-child {
            border-radius: 0 8px 0 0;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #4a5568;
            color: #e2e8f0;
        }

        tr:hover {
            background-color: #3d4a5c;
        }

        .occupancy-low { color: #fc8181; font-weight: 600; }
        .occupancy-mid { color: #f6e05e; font-weight: 600; }
        .occupancy-high { color: #68d391; font-weight: 600; }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 0;
            color: #718096;
            font-size: 12px;
            border-top: 1px solid #2d3748;
            margin-top: 30px;
        }

        /* Print styles */
        @media print {
            body {
                background-color: #1a202c !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .card, .chart-container, .table-container {
                break-inside: avoid;
            }

            .charts-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .file-upload {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Logo -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/>
                        <path d="M12 16.17L5 12.43V17c0 2.21 3.13 4 7 4s7-1.79 7-4v-4.57l-7 3.74z"/>
                    </svg>
                </div>
                <div class="logo-text">Thesis <span>Management</span></div>
            </div>
            <div class="file-upload">
                <input type="file" id="csv-input" accept=".csv">
                <button class="upload-btn" onclick="document.getElementById('csv-input').click()">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                        <polyline points="14 2 14 8 20 8" fill="none" stroke="currentColor" stroke-width="2"/>
                        <line x1="12" y1="18" x2="12" y2="12" stroke="currentColor" stroke-width="2"/>
                        <polyline points="9 15 12 12 15 15" fill="none" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Load CSV
                </button>
            </div>
            <div class="header-title">
                <h1>Pre-Lease Summary Report</h1>
                <div class="date">Generated: <span id="report-date">{{ report_date }}</span></div>
            </div>
        </header>

        <!-- Summary Cards -->
        <section class="summary-cards">
            <div class="card">
                <div class="card-value">{{ total_units }}</div>
                <div class="card-label">Total Units</div>
            </div>
            <div class="card">
                <div class="card-value">{{ overall_occupancy }}%</div>
                <div class="card-label">Overall Pre-Lease %</div>
            </div>
            <div class="card">
                <div class="card-value">{{ total_available }}</div>
                <div class="card-label">Projected Availability</div>
            </div>
            <div class="card">
                <div class="card-value">{{ total_preleased }}</div>
                <div class="card-label">Total Pre-Leased</div>
            </div>
        </section>

        <!-- Charts Grid -->
        <section class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">Pre-Lease % by Unit Type</h3>
                <div id="occupancy-bar-chart"></div>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Overall Pre-Lease Composition</h3>
                <div id="donut-chart"></div>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">New Lease vs Renewal by Unit Type</h3>
                <div id="stacked-bar-chart"></div>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Unit Availability Overview</h3>
                <div id="availability-chart"></div>
            </div>
        </section>

        <!-- Data Table -->
        <section class="table-container">
            <h3 class="table-title">Detailed Unit Data</h3>
            <table>
                <thead>
                    <tr>
                        <th>Unit Type</th>
                        <th>Total Units</th>
                        <th>Pre-Leased</th>
                        <th>Available</th>
                        <th>New Leases</th>
                        <th>Renewals</th>
                        <th>Pre-Lease %</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in table_data %}
                    <tr>
                        <td>{{ row.unit_type }}</td>
                        <td>{{ row.total_units }}</td>
                        <td>{{ row.preleased }}</td>
                        <td>{{ row.available }}</td>
                        <td>{{ row.new_leases }}</td>
                        <td>{{ row.renewals }}</td>
                        <td class="{{ row.occupancy_class }}">{{ row.occupancy }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <footer class="footer">
            Thesis Management | Pre-Lease Report
        </footer>
    </div>

    <!-- Plotly Charts -->
    <script>
        // Thesis brand color scheme - Dark theme
        const colors = {
            primary: '#1a202c',      // Dark background
            teal: '#5ba3a5',         // Thesis teal
            tealLight: '#8ecfd0',    // Light teal
            tealBg: '#2d3748',       // Dark card background
            navy: '#1a202c',         // Dark navy
            coral: '#e07a5f',        // Warm accent
            gold: '#f6e05e',         // Gold accent (brighter for dark)
            green: '#68d391',        // Success green (brighter for dark)
            red: '#fc8181',          // Warning red (brighter for dark)
            background: '#1a202c',   // Dark background
            paper: '#2d3748',        // Dark paper
            grid: '#4a5568',         // Dark grid
            text: '#e2e8f0'          // Light text
        };

        const layout = {
            paper_bgcolor: colors.paper,
            plot_bgcolor: colors.paper,
            font: { color: colors.text, family: '-apple-system, BlinkMacSystemFont, sans-serif', size: 11 },
            margin: { t: 20, r: 40, b: 80, l: 150 },
            showlegend: false
        };

        // Horizontal Bar Chart - Pre-Lease % by Unit Type
        const occupancyData = {{ occupancy_chart_data | safe }};
        Plotly.newPlot('occupancy-bar-chart', [{
            type: 'bar',
            orientation: 'h',
            x: occupancyData.values,
            y: occupancyData.labels,
            marker: {
                color: occupancyData.values.map(v => v < 70 ? colors.red : v < 90 ? colors.gold : colors.green)
            },
            text: occupancyData.values.map(v => v + '%'),
            textposition: 'inside',
            insidetextanchor: 'end',
            textfont: { color: '#ffffff', size: 11 }
        }], {
            ...layout,
            margin: { t: 10, r: 20, b: 40, l: 180 },
            xaxis: { range: [0, 105], gridcolor: colors.grid, zerolinecolor: colors.grid },
            yaxis: { gridcolor: colors.grid, tickfont: { size: 11 } }
        }, { responsive: true });

        // Donut Chart - Overall Composition
        const donutData = {{ donut_chart_data | safe }};
        Plotly.newPlot('donut-chart', [{
            type: 'pie',
            hole: 0.5,
            labels: donutData.labels,
            values: donutData.values,
            marker: { colors: [colors.teal, colors.tealLight, colors.coral] },
            textinfo: 'percent',
            textposition: 'inside',
            textfont: { color: '#ffffff', size: 12 },
            hoverinfo: 'label+value+percent'
        }], {
            ...layout,
            margin: { t: 20, r: 20, b: 40, l: 20 },
            showlegend: true,
            legend: { orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center', font: { color: colors.text, size: 11 } }
        }, { responsive: true });

        // Stacked Bar Chart - New vs Renewal
        const stackedData = {{ stacked_chart_data | safe }};
        Plotly.newPlot('stacked-bar-chart', [
            {
                type: 'bar',
                name: 'New Leases',
                x: stackedData.labels,
                y: stackedData.new_leases,
                marker: { color: colors.teal }
            },
            {
                type: 'bar',
                name: 'Renewals',
                x: stackedData.labels,
                y: stackedData.renewals,
                marker: { color: colors.tealLight }
            }
        ], {
            ...layout,
            margin: { t: 30, r: 20, b: 120, l: 50 },
            barmode: 'stack',
            showlegend: true,
            legend: { orientation: 'h', y: 1.15, x: 0.5, xanchor: 'center', font: { color: colors.text, size: 11 } },
            xaxis: { gridcolor: colors.grid, tickangle: -45, tickfont: { size: 10 } },
            yaxis: { gridcolor: colors.grid }
        }, { responsive: true });

        // Availability Chart
        const availData = {{ availability_chart_data | safe }};
        Plotly.newPlot('availability-chart', [
            {
                type: 'bar',
                name: 'Pre-Leased',
                x: availData.labels,
                y: availData.preleased,
                marker: { color: colors.teal }
            },
            {
                type: 'bar',
                name: 'Available',
                x: availData.labels,
                y: availData.available,
                marker: { color: colors.coral }
            }
        ], {
            ...layout,
            margin: { t: 30, r: 20, b: 120, l: 50 },
            barmode: 'group',
            showlegend: true,
            legend: { orientation: 'h', y: 1.15, x: 0.5, xanchor: 'center', font: { color: colors.text, size: 11 } },
            xaxis: { gridcolor: colors.grid, tickangle: -45, tickfont: { size: 10 } },
            yaxis: { gridcolor: colors.grid }
        }, { responsive: true });

        // CSV File Upload Handler
        document.getElementById('csv-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const csvData = parseCSV(event.target.result);
                if (csvData.length > 0) {
                    updateDashboard(csvData);
                    // Update the date to show when data was loaded
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    document.getElementById('report-date').textContent = dateStr;
                }
            };
            reader.readAsText(file);
        });

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const data = [];

            // Column mapping from CSV headers to our expected names
            const columnMap = {
                'Unit Type': 'unit_type',
                'Rentable Units': 'total_units',
                'Pre-Leased - Total': 'preleased',
                'Pre-Leased - New Lease': 'new_leases',
                'Pre-Leased - Renewal': 'renewals',
                'Pre-Leased - %': 'occupancy_pct',
                'Projected Availability': 'available'
            };

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length !== headers.length) continue;

                const row = {};
                headers.forEach((header, idx) => {
                    const key = columnMap[header] || header;
                    let value = values[idx].trim().replace(/^"|"$/g, '');
                    // Convert numeric values
                    if (key !== 'unit_type') {
                        value = parseFloat(value) || 0;
                    }
                    row[key] = value;
                });

                // Skip rows with 0 total units
                if (row.total_units > 0) {
                    data.push(row);
                }
            }

            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function updateDashboard(data) {
            // Calculate metrics
            let totalUnits = 0, totalPreleased = 0, totalAvailable = 0;
            let totalNewLeases = 0, totalRenewals = 0;

            data.forEach(row => {
                totalUnits += row.total_units;
                totalPreleased += row.preleased;
                totalAvailable += row.available;
                totalNewLeases += row.new_leases;
                totalRenewals += row.renewals;
            });

            const overallOccupancy = totalUnits > 0 ? ((totalPreleased / totalUnits) * 100).toFixed(1) : 0;

            // Update summary cards
            document.querySelectorAll('.card-value')[0].textContent = totalUnits;
            document.querySelectorAll('.card-value')[1].textContent = overallOccupancy + '%';
            document.querySelectorAll('.card-value')[2].textContent = totalAvailable;
            document.querySelectorAll('.card-value')[3].textContent = totalPreleased;

            // Calculate occupancy percentages
            data.forEach(row => {
                if (row.occupancy_pct <= 1) {
                    row.occupancy_pct = (row.occupancy_pct * 100);
                }
                if (!row.occupancy_pct || row.occupancy_pct === 0) {
                    row.occupancy_pct = row.total_units > 0 ? ((row.preleased / row.total_units) * 100) : 0;
                }
                row.occupancy_pct = parseFloat(row.occupancy_pct.toFixed(1));
            });

            // Sort data for occupancy chart
            const sortedData = [...data].sort((a, b) => a.occupancy_pct - b.occupancy_pct);

            // Update Occupancy Bar Chart
            Plotly.react('occupancy-bar-chart', [{
                type: 'bar',
                orientation: 'h',
                x: sortedData.map(d => d.occupancy_pct),
                y: sortedData.map(d => d.unit_type),
                marker: {
                    color: sortedData.map(d => d.occupancy_pct < 70 ? colors.red : d.occupancy_pct < 90 ? colors.gold : colors.green)
                },
                text: sortedData.map(d => d.occupancy_pct + '%'),
                textposition: 'inside',
                insidetextanchor: 'end',
                textfont: { color: '#ffffff', size: 11 }
            }], {
                ...layout,
                margin: { t: 10, r: 20, b: 40, l: 180 },
                xaxis: { range: [0, 105], gridcolor: colors.grid, zerolinecolor: colors.grid },
                yaxis: { gridcolor: colors.grid, tickfont: { size: 11 } }
            });

            // Update Donut Chart
            Plotly.react('donut-chart', [{
                type: 'pie',
                hole: 0.5,
                labels: ['New Leases', 'Renewals', 'Available'],
                values: [totalNewLeases, totalRenewals, totalAvailable],
                marker: { colors: [colors.teal, colors.tealLight, colors.coral] },
                textinfo: 'percent',
                textposition: 'inside',
                textfont: { color: '#ffffff', size: 12 },
                hoverinfo: 'label+value+percent'
            }], {
                ...layout,
                margin: { t: 20, r: 20, b: 40, l: 20 },
                showlegend: true,
                legend: { orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center', font: { color: colors.text, size: 11 } }
            });

            // Update Stacked Bar Chart
            Plotly.react('stacked-bar-chart', [
                {
                    type: 'bar',
                    name: 'New Leases',
                    x: data.map(d => d.unit_type),
                    y: data.map(d => d.new_leases),
                    marker: { color: colors.teal }
                },
                {
                    type: 'bar',
                    name: 'Renewals',
                    x: data.map(d => d.unit_type),
                    y: data.map(d => d.renewals),
                    marker: { color: colors.tealLight }
                }
            ], {
                ...layout,
                margin: { t: 30, r: 20, b: 120, l: 50 },
                barmode: 'stack',
                showlegend: true,
                legend: { orientation: 'h', y: 1.15, x: 0.5, xanchor: 'center', font: { color: colors.text, size: 11 } },
                xaxis: { gridcolor: colors.grid, tickangle: -45, tickfont: { size: 10 } },
                yaxis: { gridcolor: colors.grid }
            });

            // Update Availability Chart
            Plotly.react('availability-chart', [
                {
                    type: 'bar',
                    name: 'Pre-Leased',
                    x: data.map(d => d.unit_type),
                    y: data.map(d => d.preleased),
                    marker: { color: colors.teal }
                },
                {
                    type: 'bar',
                    name: 'Available',
                    x: data.map(d => d.unit_type),
                    y: data.map(d => d.available),
                    marker: { color: colors.coral }
                }
            ], {
                ...layout,
                margin: { t: 30, r: 20, b: 120, l: 50 },
                barmode: 'group',
                showlegend: true,
                legend: { orientation: 'h', y: 1.15, x: 0.5, xanchor: 'center', font: { color: colors.text, size: 11 } },
                xaxis: { gridcolor: colors.grid, tickangle: -45, tickfont: { size: 10 } },
                yaxis: { gridcolor: colors.grid }
            });

            // Update Table
            const tbody = document.querySelector('table tbody');
            tbody.innerHTML = data.map(row => {
                const occClass = row.occupancy_pct < 70 ? 'occupancy-low' : row.occupancy_pct < 90 ? 'occupancy-mid' : 'occupancy-high';
                return `<tr>
                    <td>${row.unit_type}</td>
                    <td>${row.total_units}</td>
                    <td>${row.preleased}</td>
                    <td>${row.available}</td>
                    <td>${row.new_leases}</td>
                    <td>${row.renewals}</td>
                    <td class="${occClass}">${row.occupancy_pct}%</td>
                </tr>`;
            }).join('');
        }
    </script>
</body>
</html>
